From c8cd5a58bfcab40e1ed7d4dfe6700a9338c4de11 Mon Sep 17 00:00:00 2001
From: Masato TOYOSHIMA <phoepsilonix@phoepsilonix.love>
Date: Sun, 23 Jul 2023 21:56:14 +0900
Subject: [PATCH] a

---
 PKGBUILD | 23 +++++++++++++++++++++--
 1 file changed, 21 insertions(+), 2 deletions(-)

diff --git a/PKGBUILD b/PKGBUILD
index af64706..e3c21fe 100644
--- a/PKGBUILD
+++ b/PKGBUILD
@@ -20,7 +20,7 @@ makedepends=("broadcom-wl-dkms>=$pkgver"
 groups=("$_linuxprefix-extramodules")
 provides=("$_pkgname=$pkgver")
 install=$_pkgname.install
-backup=('etc/modprobe.d/$_linuxprefix-broadcom-wl.conf')
+backup=("etc/modprobe.d/${_linuxprefix}-broadcom-wl.conf")
 source=(broadcom-wl-dkms.conf)
 sha256sums=('b97bc588420d1542f73279e71975ccb5d81d75e534e7b5717e01d6e6adf6a283')
 
@@ -36,6 +36,13 @@ build() {
   msg2 "$CFLAGS, ${CXXFLAGS}"
 
   fakeroot dkms build --dkmstree "$srcdir" -m "broadcom-wl/$pkgver" -k "$_kernver"
+  cd "$srcdir/$_pkgname/$pkgver/$_kernver/$CARCH/module"
+  if [ -f *.ko.zst ] ;then
+          zstd --rm -q -d *.zst
+  elif [ -f *.ko.xz ] ;then
+          xz -q -d *.xz
+  fi
+  /usr/lib/modules/${_kernver}/build/scripts/sign-file sha512 /var/lib/dkms/signing_key-${_kernver}.pem /var/lib/dkms/signing_key-${_kernver}.x509 *.ko
 }
 
 package(){
@@ -43,8 +50,20 @@ package(){
 
   install -dm755 "$pkgdir/usr/lib/modules/$_extramodules"
   cd "broadcom-wl/$pkgver/$_kernver/$CARCH/module"
+  COMPRESS=$(grep -o "CONFIG_MODULE_COMPRESS_.* 1" /usr/lib/modules/$_kernver/build/include/generated/autoconf.h)
+  COMPRESS=${COMPRESS#CONFIG_MODULE_COMPRESS_}
+  COMPRESS=${COMPRESS% 1}
+  case $COMPRESS in
+  ZSTD)
+    COMP_CMD="zstd -T0 -22 --ultra --auto-threads=physical --rm -f"
+    ;;
+  XZ)
+    COMP_CMD="xz -T0 -f -v -9 --lzma2=dict=2MiB"
+    ;;
+  esac
   install -m644 * "$pkgdir/usr/lib/modules/$_extramodules"
-  find "$pkgdir" -name '*.ko' -exec gzip -9 {} +
+  find "${pkgdir}" -name '*.ko' -exec $COMP_CMD {} +
   sed -i -e "s/EXTRAMODULES='.*'/EXTRAMODULES='$_extramodules'/" "$startdir/$_pkgname.install"
   install -D -m 644 "${srcdir}/broadcom-wl-dkms.conf" "${pkgdir}/etc/modprobe.d/${_linuxprefix}-broadcom-wl.conf"
+  install -D -m 644 "/usr/share/licenses/broadcom-wl-dkms/LICENSE" "${pkgdir}/usr/share/licenses/linux64-broadcom-wl/LICENSE"
 }
-- 
2.41.0

